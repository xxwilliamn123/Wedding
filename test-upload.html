<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Photo Upload - Wedding Website</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .test-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="icon-camera"></i> Photo Upload Test Page</h1>
        <p class="text-muted">Use this page to test your photo upload functionality before going live.</p>
        
        <div id="test-results"></div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Configuration Test</h3>
                <button id="test-config" class="test-button">
                    <i class="icon-settings"></i> Test Configuration
                </button>
                <div id="config-result"></div>
            </div>
            
            <div class="col-md-6">
                <h3>Upload Test</h3>
                <button id="test-upload" class="test-button">
                    <i class="icon-upload"></i> Test Upload
                </button>
                <div id="upload-result"></div>
            </div>
        </div>
        
        <div class="row" style="margin-top: 30px;">
            <div class="col-md-12">
                <h3>Manual Upload Test</h3>
                <form id="manual-upload-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test-name">Test Name</label>
                                <input type="text" class="form-control" id="test-name" value="Test User" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test-email">Test Email</label>
                                <input type="email" class="form-control" id="test-email" value="test@example.com" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="test-file">Test Photo</label>
                        <input type="file" class="form-control" id="test-file" accept="image/*" required>
                    </div>
                    <button type="submit" class="test-button">
                        <i class="icon-upload"></i> Upload Test Photo
                    </button>
                </form>
                <div id="manual-result"></div>
            </div>
        </div>
        
        <div class="row" style="margin-top: 30px;">
            <div class="col-md-12">
                <h3>Setup Instructions</h3>
                <div class="alert alert-info">
                    <h4>Before testing, make sure you have:</h4>
                    <ol>
                        <li>Created and deployed your Google Apps Script</li>
                        <li>Updated the <code>GOOGLE_APPS_SCRIPT_URL</code> in <code>js/photo-upload.js</code></li>
                        <li>Set your admin email in the Google Apps Script</li>
                        <li>Authorized the script to access Drive and Gmail</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        // Test configuration
        document.getElementById('test-config').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="icon-spinner"></i> Testing...';
            
            // Check if photo-upload.js is loaded
            try {
                // This will test if the script is accessible
                const scriptElement = document.querySelector('script[src*="photo-upload.js"]');
                if (!scriptElement) {
                    showResult('config-result', '❌ photo-upload.js not found. Make sure it\'s included in your page.', 'error');
                    return;
                }
                
                // Test if the URL is configured
                const testUrl = 'YOUR_GOOGLE_APPS_SCRIPT_URL';
                if (testUrl === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    showResult('config-result', '❌ Google Apps Script URL not configured. Please update js/photo-upload.js', 'error');
                } else {
                    showResult('config-result', '✅ Configuration appears correct. URL is set.', 'success');
                }
                
            } catch (error) {
                showResult('config-result', '❌ Error testing configuration: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="icon-settings"></i> Test Configuration';
            }
        });
        
        // Test upload functionality
        document.getElementById('test-upload').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="icon-spinner"></i> Testing...';
            
            // Create a test file
            const testBlob = new Blob(['test image data'], { type: 'image/jpeg' });
            const testFile = new File([testBlob], 'test-image.jpg', { type: 'image/jpeg' });
            
            // Create form data
            const formData = new FormData();
            formData.append('file', testFile);
            formData.append('fileName', 'test-image.jpg');
            formData.append('guestName', 'Test User');
            formData.append('guestEmail', 'test@example.com');
            formData.append('description', 'Test upload from test page');
            
            // Test the upload
            testUploadToGoogleAppsScript(formData)
                .then(result => {
                    showResult('upload-result', '✅ Upload test successful: ' + result.message, 'success');
                })
                .catch(error => {
                    showResult('upload-result', '❌ Upload test failed: ' + error.message, 'error');
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="icon-upload"></i> Test Upload';
                });
        });
        
        // Manual upload form
        document.getElementById('manual-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('test-file');
            const nameInput = document.getElementById('test-name');
            const emailInput = document.getElementById('test-email');
            
            if (!fileInput.files[0]) {
                showResult('manual-result', '❌ Please select a file to upload', 'error');
                return;
            }
            
            formData.append('file', fileInput.files[0]);
            formData.append('fileName', fileInput.files[0].name);
            formData.append('guestName', nameInput.value);
            formData.append('guestEmail', emailInput.value);
            formData.append('description', 'Manual test upload');
            
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="icon-spinner"></i> Uploading...';
            
            testUploadToGoogleAppsScript(formData)
                .then(result => {
                    showResult('manual-result', '✅ Manual upload successful: ' + result.message, 'success');
                    this.reset();
                })
                .catch(error => {
                    showResult('manual-result', '❌ Manual upload failed: ' + error.message, 'error');
                })
                .finally(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="icon-upload"></i> Upload Test Photo';
                });
        });
        
        // Test upload function
        async function testUploadToGoogleAppsScript(formData) {
            // Google Apps Script Web App URL
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMe170IRDjE20PZC9x0RLjTXxvvJntvOFwO-aCVse65st75KkZ4bKa6Z6-4_8J9PV3/exec';
            
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                throw new Error('Google Apps Script URL not configured');
            }
            
            // Get the file and form data
            const file = formData.get('file');
            const guestName = formData.get('guestName');
            const guestEmail = formData.get('guestEmail');
            const description = formData.get('description');
            
            console.log('Testing upload with:', {
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                guestName: guestName,
                guestEmail: guestEmail,
                description: description
            });
            
            // Convert file to base64
            const base64Data = await fileToBase64(file);
            console.log('Base64 data length:', base64Data.length);
            
            // Create URL-encoded form data
            const uploadData = new URLSearchParams();
            uploadData.append('fileName', file.name);
            uploadData.append('guestName', guestName);
            uploadData.append('guestEmail', guestEmail);
            uploadData.append('description', description || '');
            uploadData.append('fileData', base64Data);
            uploadData.append('fileType', file.type);
            
            console.log('Sending data to:', GOOGLE_APPS_SCRIPT_URL);
            console.log('Data keys:', Array.from(uploadData.keys()));
            
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: uploadData.toString()
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('Upload result:', result);
            
            if (!result.success) {
                throw new Error(result.message || 'Upload failed');
            }
            
            return result;
        }
        
        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data URL prefix (e.g., "data:image/jpeg;base64,")
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // Show result helper
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            const className = `status-${type}`;
            element.innerHTML = `<div class="test-status ${className}">${message}</div>`;
        }
        
        // Initial status
        showResult('test-results', 'Ready to test your photo upload configuration!', 'info');
    </script>
</body>
</html> 